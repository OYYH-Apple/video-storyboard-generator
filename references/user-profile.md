# 用户画像机制

用户画像用于记忆用户的偏好，在后续交互中提供个性化推荐。

---

## 画像文件结构

**存储位置：** 
- **Windows**: `C:\Users\[用户名]\.video-storyboard\user-profile.md`
- **macOS/Linux**: `~/.video-storyboard/user-profile.md`
- **统一表示**: `<用户主目录>/.video-storyboard/user-profile.md`

```markdown
# 用户画像

## 基本信息
- 创建时间：YYYY-MM-DD
- 最后更新：YYYY-MM-DD
- 交互次数：N

## 偏好统计

### 视觉风格偏好
| 风格 | 使用次数 | 最后使用 |
|------|---------|---------|
| 科技感 | 5 | 2024-01-15 |
| 活泼轻松 | 2 | 2024-01-10 |

### 主角/吉祥物偏好
| 类型 | 使用次数 | 最后使用 |
|------|---------|---------|
| 拟人化AI机器人 | 4 | 2024-01-15 |
| 无角色 | 2 | 2024-01-12 |

### 旁白风格偏好
| 风格 | 使用次数 | 最后使用 |
|------|---------|---------|
| 专业权威型 | 3 | 2024-01-15 |
| 风趣调侃型 | 2 | 2024-01-10 |

### 运镜节奏偏好
| 节奏 | 使用次数 | 最后使用 |
|------|---------|---------|
| 快速动感 | 4 | 2024-01-15 |
| 缓慢优雅 | 1 | 2024-01-08 |

### 分镜版式偏好
| 版式 | 使用次数 | 最后使用 |
|------|---------|---------|
| 极简版 | 3 | 2024-01-15 |
| 专业版 | 5 | 2024-01-16 |

### 音效/BGM偏好
| 类型 | 使用次数 | 最后使用 |
|------|---------|---------|
| 启用 | 6 | 2024-01-16 |
| 禁用 | 2 | 2024-01-10 |

### 角色提示词偏好
| 类型 | 使用次数 | 最后使用 |
|------|---------|---------|
| 启用 | 2 | 2024-01-15 |
| 不适用 | 6 | 2024-01-16 |

## 视频类型统计
| 类型 | 生成次数 | 最后生成 |
|------|---------|---------|
| 概念讲解 | 3 | 2024-01-15 |
| 产品介绍 | 2 | 2024-01-12 |

## 用户自定义偏好
- 用户备注的其他偏好记录
```

---

## 画像读取规则

### 何时读取
- 每次开始新的分镜生成任务前
- 用户明确要求"按我的偏好"时

### 如何使用画像
1. **优先推荐最高频选项**：使用次数最多的选项作为默认推荐
2. **最近偏好加权**：最近使用的选项获得更高权重
3. **结合当前上下文**：画像偏好与当前视频类型的推荐取交集

### 推荐逻辑示例

```
用户画像：
- 科技感风格使用5次
- 活泼轻松风格使用2次

当前任务：产品介绍视频

推荐顺序：
1. 科技感（画像高频 + 适合产品介绍）
2. 活泼轻松（画像次高频 + 适合产品介绍）
3. 严肃专业（无画像记录 + 适合产品介绍）
```

---

## 画像更新规则

### 更新时机
- 每次分镜生成完成后
- 用户主动修改偏好时

### 更新内容
1. **递增使用次数**：对应选项的使用次数+1
2. **更新最后使用时间**：记录本次使用时间
3. **更新交互次数**：总交互次数+1
4. **记录分镜版式选择**：极简版或专业版
5. **记录音效/BGM选择**：是否启用音效和BGM建议
6. **记录角色提示词选择**：是否生成角色提示词（故事/剧情类）

### 更新示例

**更新前：**
```
### 视觉风格偏好
| 风格 | 使用次数 | 最后使用 |
|------|---------|---------|
| 科技感 | 5 | 2024-01-15 |
```

**本次选择：科技感**

**更新后：**
```
### 视觉风格偏好
| 风格 | 使用次数 | 最后使用 |
|------|---------|---------|
| 科技感 | 6 | 2024-01-16 |
```

---

## 新用户初始化

当用户首次使用时：

1. 检查画像文件是否存在
2. 不存在则创建初始画像文件
3. 使用默认推荐引导用户选择
4. 完成首次生成后更新画像

**初始画像模板：**
```markdown
# 用户画像

## 基本信息
- 创建时间：YYYY-MM-DD
- 最后更新：YYYY-MM-DD
- 交互次数：0

## 偏好统计
（暂无数据，等待首次交互）

## 视频类型统计
（暂无数据，等待首次交互）

## 用户自定义偏好
（暂无）
```

---

## 隐私保护

### 不记录的信息
- 具体的视频内容
- 用户身份信息
- 敏感主题信息

### 仅记录的信息
- 风格选择偏好
- 视频类型统计
- 抽象的使用模式

### 数据用途
- 仅用于改进推荐
- 不用于其他目的
- 用户可随时删除画像文件

---

## 画像重置

用户可通过以下方式重置画像：

1. 删除画像文件：
   - Windows: 删除 `C:\Users\[用户名]\.video-storyboard\user-profile.md`
   - macOS/Linux: 运行 `rm ~/.video-storyboard/user-profile.md`
2. 在对话中请求重置："重置我的偏好设置"

重置后，系统将从空白画像重新开始学习。

---

## 自我迭代机制

### 迭代原则
用户画像会随着使用次数增加而更加精准：

```
交互次数    推荐精准度
1-3次       基础推荐（基于视频类型）
4-10次      学习期（开始识别偏好）
11-30次     成长期（偏好基本稳定）
30次以上    稳定期（个性化推荐成熟）
```

### 偏好稳定性判断

当某选项使用次数占总使用次数60%以上，且最近5次选择中有4次以上选择该选项时，视为"稳定偏好"。

**稳定偏好示例：**
```
科技感风格：8次使用 / 总10次 = 80% ✓ 稳定偏好
专业权威型旁白：7次使用 / 总10次 = 70% ✓ 稳定偏好
```

### 异常检测

如果用户突然选择与历史偏好差异很大的选项：

1. 记录本次选择
2. 询问用户："这是临时选择还是更新偏好？"
3. 根据用户回答决定是否调整推荐权重

---

## 实现示例

### 读取画像伪代码

```python
import os

def load_user_profile():
    # 跨平台获取用户主目录
    home = os.path.expanduser("~")
    profile_path = os.path.join(home, ".video-storyboard", "user-profile.md")
    if not os.path.exists(profile_path):
        return create_empty_profile()
    
    profile = parse_markdown(profile_path)
    return profile

def get_recommended_style(profile, video_type):
    # 获取用户历史偏好
    user_styles = profile["偏好统计"]["视觉风格偏好"]
    
    # 获取该视频类型的推荐风格
    type_styles = VIDEO_TYPE_STYLES[video_type]
    
    # 取交集并按用户偏好排序
    recommended = sort_by_user_preference(user_styles, type_styles)
    
    return recommended
```

### 更新画像伪代码

```python
def update_user_profile(profile, choices):
    # 更新各项选择的使用次数
    profile["偏好统计"]["视觉风格偏好"][choices["style"]] += 1
    profile["偏好统计"]["旁白风格偏好"][choices["narration"]] += 1
    
    # 更新视频类型统计
    profile["视频类型统计"][choices["video_type"]] += 1
    
    # 更新时间戳
    profile["基本信息"]["最后更新"] = today()
    profile["基本信息"]["交互次数"] += 1
    
    # 保存画像
    save_profile(profile)
```
